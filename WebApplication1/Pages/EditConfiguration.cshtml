@page "{id:int}"
@using System.Text.Json
@using System.Text.Json.Serialization
@{
    var jsonOptions = new JsonSerializerOptions
            {
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
                ReferenceHandler = ReferenceHandler.IgnoreCycles,
                DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull
            };
    var componentsJson = JsonSerializer.Serialize(Model.Components, jsonOptions);
}
@model WebApplication1.Pages.EditConfigurationModel
@{
    ViewData["Title"] = "Редактирование конфигурации";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-edit me-2" style="color: #764ba2;"></i>@ViewData["Title"]</h1>
        <a asp-page="/UserProfile" class="btn btn-outline-primary">
            <i class="fas fa-user me-1"></i>В профиль
        </a>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger mb-4">
            <i class="fas fa-exclamation-circle me-2"></i> @Model.ErrorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success mb-4">
            <i class="fas fa-check-circle me-2"></i> @Model.SuccessMessage
        </div>
    }

    <form method="post" id="configForm">
        <input type="hidden" name="ConfigId" value="@Model.ConfigId" />

        <!-- Основная информация о конфигурации -->
        <div class="card border-0 shadow-lg mb-4" style="border-radius: 16px;">
            <div class="card-header border-0 py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px 16px 0 0;">
                <h5 class="card-title text-white mb-0">
                    <i class="fas fa-info-circle me-2"></i>Основная информация
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold" style="color: #764ba2;">Название конфигурации</label>
                        <input type="text" class="form-control" id="configName" name="ConfigName" value="@Model.ConfigName" placeholder="Например: Игровой ПК 2025" required />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold" style="color: #764ba2;">Цель использования</label>
                        <select class="form-select" id="targetUse" name="TargetUse" required>
                            <option value="">Выберите цель</option>
                            <option value="gaming" selected="@(Model.TargetUse == "gaming")">Игровой</option>
                            <option value="professional" selected="@(Model.TargetUse == "professional")">Профессиональный</option>
                            <option value="office" selected="@(Model.TargetUse == "office")">Офисный</option>
                            <option value="student" selected="@(Model.TargetUse == "student")">Для студентов</option>
                        </select>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label fw-semibold" style="color: #764ba2;">Описание</label>
                        <textarea class="form-control" id="description" name="Description" rows="3" placeholder="Краткое описание вашей сборки...">@Model.Description</textarea>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="rgbCheckbox" name="Rgb" checked="@Model.Rgb">
                            <label class="form-check-label" for="rgbCheckbox">
                                <i class="fas fa-lightbulb me-1" style="color: #764ba2;"></i> RGB-подсветка
                            </label>
                        </div>
                    </div>

                    <!-- Поле для статуса -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold" style="color: #764ba2;">Статус конфигурации</label>
                        <select class="form-select" id="configStatus" name="Status" required>
                            <option value="draft" selected="@(Model.Status == "draft")">Черновик</option>
                            <option value="validated" selected="@(Model.Status == "validated")">Готовая сборка</option>
                        </select>
                        <small class="text-muted" id="statusHelp">Для статуса "Готовая сборка" необходимо выбрать все компоненты</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Скрытые поля для ID выбранных компонентов -->
        <input type="hidden" name="ComponentIds" id="componentIds" value="@string.Join(",", Model.ComponentIdList)" />

        <!-- Выбор комплектующих -->
        <div class="card border-0 shadow-lg mb-4" style="border-radius: 16px;">
            <div class="card-header border-0 py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px 16px 0 0;">
                <h5 class="card-title text-white mb-0">
                    <i class="fas fa-cogs me-2"></i>Выбор комплектующих
                </h5>
            </div>
            <div class="card-body p-4">
                <!-- Процессор -->
                <div class="component-section mb-4" id="cpu-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0" style="color: #764ba2;">
                            <i class="fas fa-microchip me-2"></i>Процессор
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary select-component-btn" data-type="cpu">
                            <i class="fas fa-plus me-1"></i>Выбрать
                        </button>
                    </div>
                    <div class="selected-component-placeholder p-3 rounded-3 text-center" id="cpu-placeholder" style="background: #f8f9fa; border: 2px dashed #e9ecef;">
                        <i class="fas fa-microchip fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Процессор не выбран</p>
                    </div>
                    <div class="selected-component-info d-none" id="cpu-info">
                        <div class="d-flex justify-content-between align-items-center p-3 rounded-3" style="background: #f0f3ff; border-left: 4px solid #764ba2;">
                            <div>
                                <h6 class="mb-1" id="cpu-name"></h6>
                                <small class="text-muted" id="cpu-specs"></small>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-3" style="color: #764ba2;" id="cpu-price"></span>
                                <button type="button" class="btn btn-sm btn-link text-danger remove-component" data-type="cpu">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Материнская плата -->
                <div class="component-section mb-4" id="motherboard-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0" style="color: #764ba2;">
                            <i class="fas fa-microchip me-2"></i>Материнская плата
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary select-component-btn" data-type="motherboard">
                            <i class="fas fa-plus me-1"></i>Выбрать
                        </button>
                    </div>
                    <div class="selected-component-placeholder p-3 rounded-3 text-center" id="motherboard-placeholder" style="background: #f8f9fa; border: 2px dashed #e9ecef;">
                        <i class="fas fa-microchip fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Материнская плата не выбрана</p>
                    </div>
                    <div class="selected-component-info d-none" id="motherboard-info">
                        <div class="d-flex justify-content-between align-items-center p-3 rounded-3" style="background: #f0f3ff; border-left: 4px solid #764ba2;">
                            <div>
                                <h6 class="mb-1" id="motherboard-name"></h6>
                                <small class="text-muted" id="motherboard-specs"></small>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-3" style="color: #764ba2;" id="motherboard-price"></span>
                                <button type="button" class="btn btn-sm btn-link text-danger remove-component" data-type="motherboard">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Оперативная память -->
                <div class="component-section mb-4" id="ram-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0" style="color: #764ba2;">
                            <i class="fas fa-memory me-2"></i>Оперативная память
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary select-component-btn" data-type="ram">
                            <i class="fas fa-plus me-1"></i>Выбрать
                        </button>
                    </div>
                    <div class="selected-component-placeholder p-3 rounded-3 text-center" id="ram-placeholder" style="background: #f8f9fa; border: 2px dashed #e9ecef;">
                        <i class="fas fa-memory fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Оперативная память не выбрана</p>
                    </div>
                    <div class="selected-component-info d-none" id="ram-info">
                        <div class="d-flex justify-content-between align-items-center p-3 rounded-3" style="background: #f0f3ff; border-left: 4px solid #764ba2;">
                            <div>
                                <h6 class="mb-1" id="ram-name"></h6>
                                <small class="text-muted" id="ram-specs"></small>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-3" style="color: #764ba2;" id="ram-price"></span>
                                <button type="button" class="btn btn-sm btn-link text-danger remove-component" data-type="ram">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Видеокарта -->
                <div class="component-section mb-4" id="gpu-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0" style="color: #764ba2;">
                            <i class="fas fa-plug me-2"></i>Видеокарта
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary select-component-btn" data-type="gpu">
                            <i class="fas fa-plus me-1"></i>Выбрать
                        </button>
                    </div>
                    <div class="selected-component-placeholder p-3 rounded-3 text-center" id="gpu-placeholder" style="background: #f8f9fa; border: 2px dashed #e9ecef;">
                        <i class="fas fa-plug fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Видеокарта не выбрана</p>
                    </div>
                    <div class="selected-component-info d-none" id="gpu-info">
                        <div class="d-flex justify-content-between align-items-center p-3 rounded-3" style="background: #f0f3ff; border-left: 4px solid #764ba2;">
                            <div>
                                <h6 class="mb-1" id="gpu-name"></h6>
                                <small class="text-muted" id="gpu-specs"></small>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-3" style="color: #764ba2;" id="gpu-price"></span>
                                <button type="button" class="btn btn-sm btn-link text-danger remove-component" data-type="gpu">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Накопитель -->
                <div class="component-section mb-4" id="storage-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0" style="color: #764ba2;">
                            <i class="fas fa-hdd me-2"></i>Накопитель
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary select-component-btn" data-type="storage">
                            <i class="fas fa-plus me-1"></i>Выбрать
                        </button>
                    </div>
                    <div class="selected-component-placeholder p-3 rounded-3 text-center" id="storage-placeholder" style="background: #f8f9fa; border: 2px dashed #e9ecef;">
                        <i class="fas fa-hdd fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Накопитель не выбран</p>
                    </div>
                    <div class="selected-component-info d-none" id="storage-info">
                        <div class="d-flex justify-content-between align-items-center p-3 rounded-3" style="background: #f0f3ff; border-left: 4px solid #764ba2;">
                            <div>
                                <h6 class="mb-1" id="storage-name"></h6>
                                <small class="text-muted" id="storage-specs"></small>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-3" style="color: #764ba2;" id="storage-price"></span>
                                <button type="button" class="btn btn-sm btn-link text-danger remove-component" data-type="storage">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Блок питания -->
                <div class="component-section mb-4" id="psu-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0" style="color: #764ba2;">
                            <i class="fas fa-bolt me-2"></i>Блок питания
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary select-component-btn" data-type="psu">
                            <i class="fas fa-plus me-1"></i>Выбрать
                        </button>
                    </div>
                    <div class="selected-component-placeholder p-3 rounded-3 text-center" id="psu-placeholder" style="background: #f8f9fa; border: 2px dashed #e9ecef;">
                        <i class="fas fa-bolt fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Блок питания не выбран</p>
                    </div>
                    <div class="selected-component-info d-none" id="psu-info">
                        <div class="d-flex justify-content-between align-items-center p-3 rounded-3" style="background: #f0f3ff; border-left: 4px solid #764ba2;">
                            <div>
                                <h6 class="mb-1" id="psu-name"></h6>
                                <small class="text-muted" id="psu-specs"></small>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-3" style="color: #764ba2;" id="psu-price"></span>
                                <button type="button" class="btn btn-sm btn-link text-danger remove-component" data-type="psu">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Корпус -->
                <div class="component-section mb-4" id="case-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0" style="color: #764ba2;">
                            <i class="fas fa-box me-2"></i>Корпус
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary select-component-btn" data-type="case">
                            <i class="fas fa-plus me-1"></i>Выбрать
                        </button>
                    </div>
                    <div class="selected-component-placeholder p-3 rounded-3 text-center" id="case-placeholder" style="background: #f8f9fa; border: 2px dashed #e9ecef;">
                        <i class="fas fa-box fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Корпус не выбран</p>
                    </div>
                    <div class="selected-component-info d-none" id="case-info">
                        <div class="d-flex justify-content-between align-items-center p-3 rounded-3" style="background: #f0f3ff; border-left: 4px solid #764ba2;">
                            <div>
                                <h6 class="mb-1" id="case-name"></h6>
                                <small class="text-muted" id="case-specs"></small>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-3" style="color: #764ba2;" id="case-price"></span>
                                <button type="button" class="btn btn-sm btn-link text-danger remove-component" data-type="case">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Охлаждение -->
                <div class="component-section mb-4" id="cooling-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0" style="color: #764ba2;">
                            <i class="fas fa-wind me-2"></i>Система охлаждения
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary select-component-btn" data-type="cooling">
                            <i class="fas fa-plus me-1"></i>Выбрать
                        </button>
                    </div>
                    <div class="selected-component-placeholder p-3 rounded-3 text-center" id="cooling-placeholder" style="background: #f8f9fa; border: 2px dashed #e9ecef;">
                        <i class="fas fa-wind fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Охлаждение не выбрано</p>
                    </div>
                    <div class="selected-component-info d-none" id="cooling-info">
                        <div class="d-flex justify-content-between align-items-center p-3 rounded-3" style="background: #f0f3ff; border-left: 4px solid #764ba2;">
                            <div>
                                <h6 class="mb-1" id="cooling-name"></h6>
                                <small class="text-muted" id="cooling-specs"></small>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-3" style="color: #764ba2;" id="cooling-price"></span>
                                <button type="button" class="btn btn-sm btn-link text-danger remove-component" data-type="cooling">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Индикатор совместимости -->
                <div id="compatibility-indicator" class="alert d-none mt-3"></div>
            </div>
        </div>

        <!-- Итоговая стоимость -->
        <div class="card border-0 shadow-lg mb-4" style="border-radius: 16px;">
            <div class="card-header border-0 py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px 16px 0 0;">
                <h5 class="card-title text-white mb-0">
                    <i class="fas fa-calculator me-2"></i>Итоговая стоимость
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0" style="color: #2d3748;">Общая сумма:</h4>
                    <h3 class="mb-0" id="totalPrice" style="color: #764ba2; font-weight: 700;">@Model.TotalPrice.ToString("F2") ₽</h3>
                </div>
            </div>
        </div>

        <!-- Кнопки действий -->
        <div class="d-flex gap-3 justify-content-center mb-5">
            <button type="submit" class="btn btn-primary btn-lg px-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fas fa-save me-2"></i>Сохранить изменения
            </button>
            <a asp-page="/UserProfile" class="btn btn-outline-secondary btn-lg px-5">
                <i class="fas fa-times me-2"></i>Отмена
            </a>
        </div>
    </form>
</div>

<style>
    .form-control, .form-select {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

        .form-control:focus, .form-select:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 0.2rem rgba(118, 75, 162, 0.25);
            outline: none;
        }

    .component-section {
        padding: 1.5rem;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

        .component-section:hover {
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
        }

    .btn-outline-primary {
        border-color: #764ba2;
        color: #764ba2;
        transition: all 0.3s ease;
    }

        .btn-outline-primary:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
            transform: translateY(-2px);
        }

    .btn-primary {
        border: none;
        transition: all 0.3s ease;
    }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

    .btn-outline-secondary {
        transition: all 0.3s ease;
    }

        .btn-outline-secondary:hover {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
        }

    @@media (max-width: 768px) {
        .component-section {
            padding: 1rem;
        }

        .btn-lg {
            padding: 0.5rem 1rem;
            font-size: 1rem;
        }
    }
</style>

<script>
    const componentsJson = '@Html.Raw(componentsJson)';

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM загружен, начинаем загрузку компонентов...');

        // Загружаем существующие компоненты из модели
        loadExistingComponents();

        // Обработчики для кнопок выбора компонентов
        document.querySelectorAll('.select-component-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                saveFormData();
                const componentType = this.dataset.type;
                window.location.href = `/Components?category=${componentType}&returnUrl=${encodeURIComponent('/EditConfiguration/' + @Model.ConfigId)}&returnType=${componentType}`;
            });
        });

        // Обработчики для кнопок удаления компонентов
        document.querySelectorAll('.remove-component').forEach(btn => {
            btn.addEventListener('click', function() {
                const type = this.dataset.type;
                removeComponent(type);
            });
        });

        // Обработчик изменения статуса
        const statusSelect = document.getElementById('configStatus');
        if (statusSelect) {
            statusSelect.addEventListener('change', function() {
                validateStatusAvailability();
                saveFormData();
            });
        }

        // Обработчики для сохранения данных при вводе
        const configName = document.getElementById('configName');
        const targetUse = document.getElementById('targetUse');
        const description = document.getElementById('description');
        const rgbCheckbox = document.getElementById('rgbCheckbox');

        if (configName) configName.addEventListener('input', saveFormData);
        if (targetUse) targetUse.addEventListener('change', saveFormData);
        if (description) description.addEventListener('input', saveFormData);
        if (rgbCheckbox) rgbCheckbox.addEventListener('change', saveFormData);

        // Проверяем, есть ли выбранный компонент в localStorage
        checkForSelectedComponent();

        // Обработчик отправки формы
        const configForm = document.getElementById('configForm');
        if (configForm) {
            configForm.addEventListener('submit', function(e) {
                const status = document.getElementById('configStatus').value;
                const allComponentsSelected = checkAllComponentsSelected();

                if (status === 'validated' && !allComponentsSelected) {
                    e.preventDefault();
                    alert('Невозможно сохранить как готовую сборку. Выбраны не все компоненты.');
                    return false;
                }

                updateComponentIdsField();
                return true;
            });
        }
    });

    function loadExistingComponents() {
        try {
            // Получаем данные о компонентах из модели
    @{
        var serializedComponents = System.Text.Json.JsonSerializer.Serialize(Model.Components, new System.Text.Json.JsonSerializerOptions
            {
                PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase,
                ReferenceHandler = System.Text.Json.Serialization.ReferenceHandler.IgnoreCycles,
                DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull
            });
    }
            const componentsJson = '@Html.Raw(serializedComponents)';
            console.log('Получены компоненты из модели (JSON):', componentsJson);

            if (!componentsJson || componentsJson === '[]' || componentsJson === 'null' || componentsJson === '') {
                console.log('Нет компонентов для загрузки');
                return;
            }

            const components = JSON.parse(componentsJson);
            console.log('Распарсенные компоненты:', components);

            if (!components || components.length === 0) {
                console.log('Компоненты отсутствуют');
                return;
            }

            // Очищаем localStorage и загружаем компоненты
            let allComponents = {};

            components.forEach((comp, index) => {
                console.log(`Обработка компонента ${index}:`, comp);

                // Убедимся, что тип в нижнем регистре
                const type = comp.type ? comp.type.toLowerCase() : '';
                if (!type) {
                    console.warn('Компонент без типа:', comp);
                    return;
                }

                allComponents[type] = {
                    id: comp.id,
                    name: comp.name || '',
                    type: type,
                    price: comp.price || 0,
                    specs: comp.specs || {}
                };
            });

            console.log('Сохранение в localStorage:', allComponents);
            localStorage.setItem('allComponents', JSON.stringify(allComponents));

            // Отображаем компоненты на странице
            Object.values(allComponents).forEach(component => {
                addComponentToPage(component);
            });

            // Обновляем поле с ID компонентов
            updateComponentIdsField();
            checkAllCompatibility();
            validateStatusAvailability();

            console.log('Загрузка компонентов завершена');
        } catch (e) {
            console.error('Ошибка при загрузке компонентов:', e);
        }
    }

    function saveFormData() {
        const formData = {
            configName: document.getElementById('configName')?.value || '',
            targetUse: document.getElementById('targetUse')?.value || '',
            description: document.getElementById('description')?.value || '',
            rgb: document.getElementById('rgbCheckbox')?.checked || false,
            status: document.getElementById('configStatus')?.value || 'draft'
        };
        localStorage.setItem('configurationFormData', JSON.stringify(formData));
        console.log('Данные формы сохранены', formData);
    }

    function checkForSelectedComponent() {
        const selectedComponent = localStorage.getItem('selectedComponent');
        if (selectedComponent) {
            try {
                console.log('Найден выбранный компонент:', selectedComponent);
                const component = JSON.parse(selectedComponent);

                let allComponents = {};
                const savedComponents = localStorage.getItem('allComponents');
                if (savedComponents) {
                    allComponents = JSON.parse(savedComponents);
                }

                allComponents[component.type] = component;
                localStorage.setItem('allComponents', JSON.stringify(allComponents));
                addComponentToPage(component);
                checkAllCompatibility();
                localStorage.removeItem('selectedComponent');
                console.log('Компонент добавлен на страницу');
            } catch (e) {
                console.error('Ошибка при парсинге компонента', e);
            }
        }
    }

    function addComponentToPage(component) {
        const type = component.type;
        console.log(`Добавление компонента типа ${type}:`, component);

        const placeholder = document.getElementById(`${type}-placeholder`);
        const info = document.getElementById(`${type}-info`);
        const nameSpan = document.getElementById(`${type}-name`);
        const specsSpan = document.getElementById(`${type}-specs`);
        const priceSpan = document.getElementById(`${type}-price`);

        if (placeholder && info && nameSpan && priceSpan) {
            placeholder.classList.add('d-none');
            info.classList.remove('d-none');
            nameSpan.textContent = component.name;

            let specs = component.specs || {};
            if (typeof specs === 'string') {
                try {
                    specs = JSON.parse(specs);
                } catch (e) {
                    console.error('Ошибка парсинга спецификаций', e);
                    specs = {};
                }
            }

            let specsText = '';
            if (type === 'cpu') {
                specsText = `${specs.socket || '?'} | ${specs.cores || '?'} ядер | ${specs.tdp || '?'}Вт`;
            } else if (type === 'motherboard') {
                specsText = `${specs.socket || '?'} | ${specs.ramType || '?'} | ${specs.formFactor || '?'}`;
            } else if (type === 'ram') {
                specsText = `${specs.ramType || '?'} ${specs.capacityGb || '?'}ГБ | ${specs.speedMhz || '?'}МГц`;
            } else if (type === 'gpu') {
                specsText = `${specs.pcieVersion || '?'} | ${specs.vramGb || '?'}ГБ | ${specs.tdp || '?'}Вт`;
            } else if (type === 'storage') {
                specsText = `${specs.interface || '?'} | ${specs.capacityGb || '?'}ГБ`;
            } else if (type === 'psu') {
                specsText = `${specs.wattage || '?'}Вт | ${specs.efficiencyRating || '?'}`;
            } else if (type === 'case') {
                specsText = `${specs.formFactor || '?'} | ${specs.size || '?'}`;
            } else if (type === 'cooling') {
                specsText = `${specs.coolerType || '?'} | ${specs.tdpSupport || '?'}Вт | ${specs.fanRpm || '?'} RPM`;
            }

            if (specsSpan) specsSpan.textContent = specsText;

            const price = parseFloat(component.price) || 0;
            priceSpan.textContent = `${price.toLocaleString('ru-RU')} ₽`;

            const section = document.getElementById(`${type}-section`);
            if (section) {
                section.dataset.componentId = component.id;
                section.dataset.componentPrice = price;
                section.dataset.specs = JSON.stringify(specs);
            }

            calculateTotalPrice();
            updateComponentIdsField();
            setTimeout(checkAllCompatibility, 100);
            validateStatusAvailability();
            saveFormData();

            console.log(`Компонент типа ${type} успешно добавлен`);
        } else {
            console.error('Не найдены элементы для типа:', type);
        }
    }

    function removeComponent(type) {
        console.log(`Удаление компонента типа ${type}`);

        const placeholder = document.getElementById(`${type}-placeholder`);
        const info = document.getElementById(`${type}-info`);
        const section = document.getElementById(`${type}-section`);

        if (placeholder && info) {
            placeholder.classList.remove('d-none');
            info.classList.add('d-none');

            if (section) {
                delete section.dataset.componentId;
                delete section.dataset.componentPrice;
                delete section.dataset.specs;
            }

            const savedComponents = localStorage.getItem('allComponents');
            if (savedComponents) {
                try {
                    const allComponents = JSON.parse(savedComponents);
                    delete allComponents[type];
                    localStorage.setItem('allComponents', JSON.stringify(allComponents));
                    console.log(`Компонент типа ${type} удален из localStorage`);
                } catch (e) {
                    console.error('Ошибка при удалении из localStorage', e);
                }
            }

            calculateTotalPrice();
            updateComponentIdsField();
            checkAllCompatibility();
            validateStatusAvailability();
            saveFormData();
        }
    }

    function updateComponentIdsField() {
        const componentIds = [];
        const types = ['cpu', 'motherboard', 'ram', 'gpu', 'storage', 'psu', 'case', 'cooling'];

        types.forEach(type => {
            const section = document.getElementById(`${type}-section`);
            if (section && section.dataset.componentId) {
                componentIds.push(parseInt(section.dataset.componentId));
            }
        });

        const componentIdsField = document.getElementById('componentIds');
        if (componentIdsField) {
            componentIdsField.value = componentIds.join(',');
            console.log('Обновлены ID компонентов:', componentIds.join(','));
        }
    }

    function calculateTotalPrice() {
        let total = 0;
        const types = ['cpu', 'motherboard', 'ram', 'gpu', 'storage', 'psu', 'case', 'cooling'];

        types.forEach(type => {
            const section = document.getElementById(`${type}-section`);
            if (section && section.dataset.componentPrice) {
                total += parseFloat(section.dataset.componentPrice) || 0;
            }
        });

        const totalPriceElement = document.getElementById('totalPrice');
        if (totalPriceElement) {
            totalPriceElement.textContent = `${total.toLocaleString('ru-RU')} ₽`;
        }

        return total;
    }

    function checkAllCompatibility() {
        const selectedComponents = {};
        const types = ['cpu', 'motherboard', 'ram', 'gpu', 'storage', 'psu', 'case', 'cooling'];

        // Собираем все выбранные компоненты
        types.forEach(type => {
            const section = document.getElementById(`${type}-section`);
            if (section && section.dataset.componentId) {
                let specs = null;
                try {
                    specs = section.dataset.specs ? JSON.parse(section.dataset.specs) : null;
                } catch (e) {
                    console.error('Ошибка парсинга спецификаций для', type, e);
                }
                selectedComponents[type] = {
                    id: parseInt(section.dataset.componentId),
                    specs: specs
                };
            }
        });

        // Сбрасываем стили несовместимости
        types.forEach(type => {
            const section = document.getElementById(`${type}-section`);
            if (section) {
                section.style.borderColor = '';
                section.style.backgroundColor = '';
            }
        });

        const issues = [];

        // CPU ↔ Motherboard (сокет)
        if (selectedComponents.cpu && selectedComponents.motherboard) {
            const cpuSocket = selectedComponents.cpu.specs?.socket;
            const moboSocket = selectedComponents.motherboard.specs?.socket;
            if (cpuSocket && moboSocket && cpuSocket !== moboSocket) {
                issues.push(`❌ Процессор (${cpuSocket}) и материнская плата (${moboSocket}) имеют разные сокеты`);
                markIncompatible('cpu', 'motherboard');
            }
        }

        // RAM ↔ Motherboard (тип памяти)
        if (selectedComponents.ram && selectedComponents.motherboard) {
            const ramType = selectedComponents.ram.specs?.ramType;
            const moboRamType = selectedComponents.motherboard.specs?.ramType;
            if (ramType && moboRamType && ramType !== moboRamType) {
                issues.push(`❌ Оперативная память (${ramType}) несовместима с материнской платой (${moboRamType})`);
                markIncompatible('ram', 'motherboard');
            }
        }

        // Motherboard ↔ Case (форм-фактор)
        if (selectedComponents.motherboard && selectedComponents.case) {
            const moboFormFactor = selectedComponents.motherboard.specs?.formFactor;
            const caseFormFactor = selectedComponents.case.specs?.formFactor;
            if (moboFormFactor && caseFormFactor && moboFormFactor !== caseFormFactor) {
                issues.push(`❌ Материнская плата (${moboFormFactor}) не подходит к корпусу (${caseFormFactor})`);
                markIncompatible('motherboard', 'case');
            }
        }

        // PSU мощность
        if (selectedComponents.psu) {
            let totalPower = 0;
            if (selectedComponents.cpu?.specs?.tdp) totalPower += selectedComponents.cpu.specs.tdp;
            if (selectedComponents.gpu?.specs?.tdp) totalPower += selectedComponents.gpu.specs.tdp;

            const psuWattage = selectedComponents.psu.specs?.wattage;
            if (psuWattage && totalPower > 0) {
                if (psuWattage < totalPower * 1.2) {
                    issues.push(`❌ Мощность БП (${psuWattage}Вт) недостаточна (требуется ~${Math.ceil(totalPower * 1.2)}Вт)`);
                    markIncompatible('psu');
                }
            }
        }

        // Cooling ↔ CPU (TDP)
        if (selectedComponents.cooling && selectedComponents.cpu) {
            const coolingTdp = selectedComponents.cooling.specs?.tdpSupport;
            const cpuTdp = selectedComponents.cpu.specs?.tdp;
            if (coolingTdp && cpuTdp && coolingTdp < cpuTdp) {
                issues.push(`❌ Охлаждение (${coolingTdp}Вт) не справится с процессором (${cpuTdp}Вт)`);
                markIncompatible('cooling', 'cpu');
            }
        }

        // Отображаем предупреждения
        const indicator = document.getElementById('compatibility-indicator');
        if (indicator) {
            if (issues.length > 0) {
                indicator.className = 'alert alert-warning mt-3';
                indicator.innerHTML = '<strong><i class="fas fa-exclamation-triangle me-2"></i>Проблемы совместимости:</strong><ul class="mb-0 mt-2">' +
                    issues.map(issue => `<li>${issue}</li>`).join('') + '</ul>';
                indicator.classList.remove('d-none');
            } else if (Object.keys(selectedComponents).length > 0) {
                indicator.className = 'alert alert-success mt-3';
                indicator.innerHTML = '<strong><i class="fas fa-check-circle me-2"></i>Все компоненты совместимы!</strong>';
                indicator.classList.remove('d-none');
            } else {
                indicator.classList.add('d-none');
            }
        }
    }

    function markIncompatible(...types) {
        types.forEach(type => {
            const section = document.getElementById(`${type}-section`);
            if (section) {
                section.style.borderColor = '#dc3545';
                section.style.backgroundColor = '#fff5f5';
            }
        });
    }

    function validateStatusAvailability() {
        const statusSelect = document.getElementById('configStatus');
        const statusHelp = document.getElementById('statusHelp');
        if (!statusSelect || !statusHelp) return;

        const allComponentsSelected = checkAllComponentsSelected();
        console.log('Проверка статуса:', statusSelect.value, 'Все компоненты выбраны:', allComponentsSelected);

        if (statusSelect.value === 'validated' && !allComponentsSelected) {
            statusSelect.value = 'draft';
            statusHelp.innerHTML = '<span class="text-danger">Для статуса "Готовая сборка" необходимо выбрать все компоненты. Статус изменен на "Черновик".</span>';
        } else if (statusSelect.value === 'validated' && allComponentsSelected) {
            statusHelp.innerHTML = '<span class="text-success">Все компоненты выбраны. Можно сохранить как готовую сборку.</span>';
        } else {
            statusHelp.innerHTML = 'Для статуса "Готовая сборка" необходимо выбрать все компоненты';
        }
        saveFormData();
    }

    function checkAllComponentsSelected() {
        const requiredTypes = ['cpu', 'motherboard', 'ram', 'gpu', 'storage', 'psu', 'case', 'cooling'];
        for (let type of requiredTypes) {
            const section = document.getElementById(`${type}-section`);
            if (!section || !section.dataset.componentId) {
                return false;
            }
        }
        return true;
    }
</script>